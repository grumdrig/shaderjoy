<!doctype html>
<title>Shaderjoy</title>
<div><i>Shaderjoy</i></div>
<canvas draggable=true></canvas>
<div id=status></div>
<div><input name="s" type=text></input></div>
<div id=err></div>
<form>
<style>
	canvas {XXborder: solid 1px blue}
	input { font-size: 14px; }
	#err { color: #800; }
</style>
<script>

let canvas = document.querySelector("canvas");
canvas.width = 640;
canvas.height = 480;
let gl = canvas.getContext("webgl2");
let program;
let shader = "";
let filename = window.location.search.substring(3) || "default.glsl";
document.querySelector("input").value = filename;

canvas.addEventListener("drag", function (e) {
	if (e.clientX > 0 && e.clientY > 0) {
		canvas.width = e.x - canvas.offsetLeft;
		canvas.height = e.y - canvas.offsetTop;
	}
});

function go(glsl) {
	shader = glsl;

	let vertexShader = gl.createShader(gl.VERTEX_SHADER);
	gl.shaderSource(vertexShader, `#version 300 es
		precision highp float;

		in vec2 aPosition;

		void main() {
			gl_Position = vec4(aPosition, 0, 1);
		}
	`);
	gl.compileShader(vertexShader);
	if (!gl.getShaderParameter(vertexShader, gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(vertexShader));

	let fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
	gl.shaderSource(fragmentShader, `#version 300 es
		precision highp float;

		out vec4 FragColor;

		uniform vec3  iResolution;
		uniform float iGlobalTime;

		#line 1
		${glsl}

		void main() {
			mainImage(FragColor, gl_FragCoord.xy);
		}
	`);
	gl.compileShader(fragmentShader);
	if (!gl.getShaderParameter(fragmentShader, gl.COMPILE_STATUS)) throw new Error(gl.getShaderInfoLog(fragmentShader), filename);

	program = gl.createProgram()
	gl.attachShader(program, vertexShader);
	gl.attachShader(program, fragmentShader);
	gl.linkProgram(program);
	if (!gl.getProgramParameter(program, gl.LINK_STATUS)) throw new Error(gl.getProgramInfoLog(program));
	gl.useProgram(program);

	gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1, +1,-1, -1,+1,
		                                             -1,+1, +1,-1, +1,+1]), gl.STATIC_DRAW, 0);
	gl.vertexAttribPointer(0, 2, gl.FLOAT, gl.FALSE, 0, 0);
	gl.enableVertexAttribArray(0);

	window.requestAnimationFrame(tick);
}

function reload() {
	var xhr = new XMLHttpRequest();
	xhr.open("GET", filename + "?now=" + +new Date(), true);
	//xhr.responseType = "blob";
	xhr.onload = function (e) {
		if (this.status != 200) throw new Error("Error loading script");
		setTimeout(reload, 200);
		if (shader !== this.responseText) {
			console.log("loaded");
			try {
				document.querySelector("#err").innerText = "";
				go(this.responseText);
			} catch (e) {
				document.querySelector("#err").innerText = e;
			}

		}
	}
	xhr.send();
}

const T0 = +new Date()/1000;

function tick() {
	gl.viewport(0, 0, canvas.width, canvas.height);
	const now = +new Date()/1000 - T0;
	document.querySelector("#status").innerText = now.toFixed(2);
	gl.uniform1f(gl.getUniformLocation(program, "iGlobalTime"), now);
	gl.uniform3f(gl.getUniformLocation(program, "iResolution"), canvas.width, canvas.height, 1);
	gl.drawArrays(gl.TRIANGLES, 0, 6);
	window.requestAnimationFrame(tick);
}

reload();

</script>